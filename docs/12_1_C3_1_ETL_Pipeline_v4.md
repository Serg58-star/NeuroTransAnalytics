# C3.1 — ETL‑пайплайн для модели данных v4

## 1. Назначение документа

Документ описывает **ETL‑пайплайн (Extract–Transform–Load)** проекта *NeuroTransAnalytics* версии v4.

Цель ETL:

* преобразовать исторические данные тестирования СЗР в логическую модель **C2.1**;
* сохранить полную трассируемость от исходных файлов до событийного уровня;
* обеспечить воспроизводимость и контроль качества входных данных.

ETL является **необратимым методическим этапом**: ошибки или упрощения здесь приводят к систематическим искажениям всех последующих сценариев.

---

## 2. Источники данных (Extract)

### 2.1. Типы источников

Исторические данные могут поступать из:

* Microsoft Access (основной архив);
* CSV / TSV экспортов;
* промежуточных форматов предыдущих этапов анализа.

Для каждого источника фиксируются:

* тип файла;
* версия схемы;
* период охвата данных;
* контрольная сумма файла.

---

### 2.2. Минимальный состав извлекаемых данных

Из каждого источника должны быть извлечены:

* идентификатор испытуемого;
* дата и время тестирования;
* тип теста;
* последовательность стимулов;
* времена предъявления и реакции;
* параметры стимула (цвет, позиция);
* признаки ошибок и пропусков.

---

## 3. Первичная нормализация (Transform — этап 1)

### 3.1. Временная нормализация

* все временные значения приводятся к миллисекундам;
* фиксируется источник системного времени;
* устраняются неоднозначности округления.

---

### 3.2. Нормализация идентификаторов

* каждому испытуемому присваивается новый `subject_id`;
* прямые персональные данные не переносятся;
* соответствие старых и новых идентификаторов хранится отдельно (при необходимости).

---

## 4. Формирование событийного слоя (Transform — этап 2)

### 4.1. Формирование TestSession

Для каждого сеанса:

* создаётся `TestSession`;
* определяется фаза (Ф₁ / Ф₂ / Ф₃, если применимо);
* фиксируется версия конфигурации теста.

---

### 4.2. Формирование StimulusEvent

Для каждого предъявления стимула:

* создаётся отдельный `StimulusEvent`;
* определяется роль стимула (test / masking / intermediate);
* фиксируются:

  * цвет;
  * пространственная локализация;
  * порядковый номер;
  * PSI_test / PSI_mask / PSI_transition;
  * идентификаторы фона и маскировки.

Ключевое требование:

* **один стимул — одно событие**, без агрегации.

---

### 4.3. Формирование ResponseEvent

Для каждого тестового стимула:

* создаётся `ResponseEvent`;
* связывается строго с соответствующим `StimulusEvent`;
* фиксируются RT и флаги валидности.

Реакции на маскирующие стимулы **не включаются**.

---

## 5. Восстановление PSI (Transform — этап 3)

ETL обязан явно восстановить:

* `PSI_test` — интервал перед тестовым стимулом;
* `PSI_mask` — интервалы, связанные с маскирующими стимулами;
* `PSI_transition` — переход от последнего маскирующего к первому тестовому стимулу.

Если исходные данные не содержат явных PSI:

* они вычисляются детерминированно по временным меткам;
* формулы и допущения фиксируются в логах ETL.

---

## 6. Контроль качества ETL (QC)

На этапе ETL выполняются:

* проверка целостности цепочек стимулов;
* контроль количества стимулов и реакций;
* выявление пропусков и дубликатов;
* проверка диапазонов RT и PSI.

Любые аномалии:

* логируются;
* не «исправляются автоматически»;
* передаются в последующие уровни как метаданные.

---

## 7. Загрузка данных (Load)

### 7.1. Загрузка в SQLite

В SQLite загружаются:

* Subject;
* TestSession;
* StimulusEvent;
* ResponseEvent;
* сущности дизайна теста.

---

### 7.2. Версионность ETL

Каждый прогон ETL имеет:

* версию пайплайна;
* дату запуска;
* ссылку на исходные файлы;
* журнал преобразований.

---

## 8. Результаты ETL

Успешный ETL‑прогон формирует:

* полностью нормализованный событийный слой;
* отчёт о качестве данных;
* базу для расчётов C3.2.

---

## 9. Ограничения и предостережения

Недопустимо:

* редуцировать события на этапе ETL;
* удалять атипичные реакции;
* подменять восстановленные PSI аппроксимациями без фиксации.

---

## 10. Итоговая роль документа

C3.1 обеспечивает:

* корректный вход данных в архитектуру v4;
* методическую чистоту всех последующих вычислений;
* основу для расчёта компонент временной архитектуры реакции.
