# Protocol_Architecture_Alignment_v4
## Протокол согласования архитектуры v4 (Discussion ↔ Tom_1–Tom_6)

**Проект:** NeuroTransAnalytics v4  
**Документ:** Protocol_Architecture_Alignment_v4.md  
**Назначение:** зафиксировать согласованные решения по расхождениям между документом обсуждения (`NeuroTransAnalytics_Discussion_v4_Normalized`) и канонической документацией Tom_1–Tom_6.  
**Статус:** действующее проектное решение (для включения в документацию).

---

## 0. Основание и принцип выбора решений

Решения принимаются **в духе** документа обсуждения:

- **ядро строгое — интерфейс свободный**;
- функциональность расширяется через сценарии и режимы работы;
- методология не “блокирует”, а сопровождает и объясняет.

При этом канонические ограничения Tom_1–Tom_6 сохраняются там, где они обеспечивают:
- воспроизводимость,
- трассируемость,
- версионность,
- методическую допустимость интерпретаций.

---

## 1. Решение: стартовая пользовательская ось (C3.4 → C3.5 → C4)

### 1.1. Проблема
В обсуждении реализация подаётся как переход от **C3.4 → C3.5 → C4**, тогда как канон v4 требует полного каскада C3.1–C3.5.

### 1.2. Решение
**Принято как новое правило (UI/навигация):**
- основная пользовательская логика в приложении начинается со сценариев **C3.4** и ведёт к **C3.5 → C4**.

**Возврат к канону (вычислительная обязательность):**
- вычислительно C3.4 допустим **только при наличии подготовленного слоя**:
  - C3.1 (ETL),
  - C3.2 (Component Timing),
  - C3.3 (QC & Aggregation).

### 1.3. Формула компромисса
> C3.1–C3.3 не являются первичной пользовательской навигацией, но являются обязательной вычислительной инфраструктурой.

---

## 2. Решение: “визуализация без C3.4”

### 2.1. Проблема
В обсуждении допускается визуализация без C3.4 (как учебный эксперимент), тогда как канон C3.5 запрещает визуализацию без артефактов C3.4.

### 2.2. Решение
**Возврат к канону (обязательное правило):**
- слой **C3.5** визуализирует **только** стандартизированные артефакты C3.4:
  - `ScenarioResult`
  - `DistributionPack`
  - `ContrastPack`

**Принято как новое правило (расширение функционала):**
- допускается отдельный режим быстрого просмотра данных:
  - **Exploratory Preview (не-каноническая визуализация)**

Этот режим:
- не является C3.5,
- не создаёт артефактов C3.5,
- всегда маркируется как **неинтерпретируемый** на уровне C4.

### 2.3. Обязательная маркировка
Каждый график Exploratory Preview обязан иметь статус:
- `non_canonical_preview = True`
- предупреждение: **“Не является артефактом C3.5. Не подлежит интерпретации C4.”**

---

## 3. Решение: приоритет “богатство функционала” vs “методическая идеальность”

### 3.1. Проблема
В обсуждении фиксируется приоритет функциональности, тогда как канон v4 задаёт жёсткие запреты на нефомализованные действия.

### 3.2. Решение
**Принято как новое правило:**
- проект v4 реализуется как **исследовательская студия** с высокой функциональностью интерфейса,
  но со строгим вычислительным ядром.

**Возврат к канону (границы свободы):**
- свобода допускается:
  - в выборе сценариев,
  - в параметризации сценариев,
  - в навигации и режиме работы,
  - в числе параллельных представлений.

- свобода **не допускается**:
  - в нарушении вычислительных контрактов C3.4,
  - в “скрытых вычислениях” на уровне C3.5,
  - в выводах C4 без значимости/допустимости.

### 3.3. Итоговая формула
> Функционал расширяется через число сценариев и параметров, а не через снятие методологических запретов.

---

## 4. Решение: виртуальные трансформации и “псевдомодификации данных”

### 4.1. Проблема
В обсуждении виртуальные трансформации рассматриваются как центральный инструмент, но канон v4 требует нерушимости первичных данных и строгой версионности.

### 4.2. Решение
**Принято как новое правило:**
- виртуальные трансформации разрешены как отдельный режим:
  - **Simulation / Design Mode**

**Возврат к канону (обязательные требования):**
1. первичные данные **никогда не изменяются**;
2. любая трансформация оформляется как отдельная версия данных/артефактов;
3. каждый результат обязан содержать метаданные происхождения:
   - `source = historical | simulated`
   - параметры трансформации
   - `scenario_version`
   - `component_algo_version`
   - `qc_gate`

---

## 5. Решение: “GUI никогда не считает” и границы ответственности слоёв

### 5.1. Проблема
В обсуждении утверждается принцип “GUI не считает”, но местами допускается смешение группировок/контрастов как части визуализации.

### 5.2. Решение
**Принято как новое правило:**
- GUI не выполняет вычислений и не модифицирует данные.
GUI:
- собирает параметры,
- вызывает core,
- отображает артефакты,
- формирует объяснения/подсказки.

**Возврат к канону (разделение ответственности):**
- любая агрегация, контраст, группировка, вычисление значимости = **C3.4**;
- C3.5 = только отображение уже вычисленных артефактов.

---

## 6. Итоговая фиксация (коротко)

1. **UI-ось проекта:** C3.4 → C3.5 → C4 (принято).  
2. **Вычислительная инфраструктура обязательна:** C3.1–C3.3 сохраняются как канон (принято).  
3. **C3.5 визуализирует только артефакты C3.4** (возврат к канону).  
4. **Exploratory Preview разрешён**, но как неканонический режим без интерпретации (принято).  
5. **Simulation / Design Mode разрешён**, но только с версионностью и без изменения raw (принято).  
6. **GUI не считает — core считает** (принято).

---

## 7. Практическое следствие для разработки

Для реализации данных решений требуется:

- единый **Scenario Engine (C3.4)** как вычислительное ядро;
- единый формат артефактов результата (ScenarioResult/DistributionPack/ContrastPack);
- строгий визуализационный слой **C3.5**;
- отдельный слой методологического сопровождения (warnings/suggestions);
- механизм версионности и метаданных происхождения результатов.

---
